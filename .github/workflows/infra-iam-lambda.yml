name: Infra - IAM & Lambda

on:
  push:
    branches: [main, suhyun]
    paths:
      - "pipeline/Infra/iam/**"
      - "pipeline/Infra/lambda/**"
      - "pipeline/Infra/attach_sm_invoke_lambda.tf"
      - "pipeline/Infra/main.tf"
  workflow_dispatch:
    inputs:
      environment:
        description: "환경(dev/prod 등)"
        required: false
        default: "dev"
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: "dev"

concurrency:
  group: pipeline-${{ inputs.environment }}
  cancel-in-progress: true

jobs:
  apply-iam-lambda:
    runs-on: ubuntu-latest
    permissions: {id-token: write, contents: read}
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Init
        working-directory: pipeline/Infra
        run: |
          terraform init -input=false -reconfigure -backend-config="${{ github.workspace }}/.github/terraform/backend.hcl"
      - name: Select workspace
        working-directory: pipeline/Infra
        run: |
          terraform workspace select "${{ inputs.environment }}" \
            || terraform workspace new "${{ inputs.environment }}"
      - name: Force-unlock stale state lock (safe to ignore if none)
        working-directory: pipeline/Infra
        run: |
          set -Eeuo pipefail
          LOCK_ID="finguard-model-artifacts/env:/${{ inputs.environment }}/sagemaker-pipeline/infra.tfstate"
          terraform force-unlock -force "$LOCK_ID" || true
      - name: Apply IAM & Lambda modules only
        working-directory: pipeline/Infra
        run: |
          set -Eeuo pipefail
          terraform apply -auto-approve \
            -target=module.iam \
            -target=module.lambda
      - name: Read Terraform outputs (role & lambda)
        working-directory: pipeline/Infra
        run: |
          set -Eeuo pipefail
          echo "SAGEMAKER_JOB_ROLE=$(terraform output -raw sagemaker_job_role_arn)" >> "$GITHUB_ENV"
          echo "GET_PREV_AUC_LAMBDA_ARN=$(terraform output -raw get_previous_auc_lambda_arn)" >> "$GITHUB_ENV"

