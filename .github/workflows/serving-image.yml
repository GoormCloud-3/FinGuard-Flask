name: Serving - Build & Push Image

on:
  push:
    branches: [ main, suhyun ]
    paths:
      - "Modeling_SG/pipeline/Serving/**"
  workflow_dispatch:
    inputs:
      tag:
        description: "이미지 태그(기본: 커밋SHA)"
        required: false
        default: ""
  workflow_call:
    inputs:
      tag:
        required: false
        type: string
        default: ""

concurrency:
  group: serving-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions: { id-token: write, contents: read }
    env:
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push
        working-directory: Modeling_SG/pipeline/Serving
        run: |
          set -Eeuo pipefail
          IMAGE="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/finguard/pipeline-serving:${GITHUB_SHA}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE pushed: $IMAGE"

